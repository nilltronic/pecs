<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Card Builder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    #controls {
      margin-bottom: 20px;
    }
    #preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border: 1px solid #ccc;
      padding: 10px;
      min-height: 120px;
    }
    .card {
      border: 1px solid #333;
      padding: 10px;
      background: #f9f9f9;
      text-align: center;
      width: 120px;
      cursor: grab;
    }
    .card img {
      max-width: 100px;
      max-height: 80px;
      display: block;
      margin: 0 auto 5px;
    }
    .card.dragging {
      opacity: 0.5;
    }
    .suggestions {
      border: 1px solid #aaa;
      max-height: 100px;
      overflow-y: auto;
      background: white;
      position: absolute;
      z-index: 2000;
    }
    .suggestions div {
      padding: 5px;
      cursor: pointer;
    }
    .suggestions div:hover {
      background: #eef;
    }
    /* Edit modal */
    #editModal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }
    #editModal .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
    }
    #editModal input, #editModal button {
      margin: 6px 0;
      padding: 8px;
      width: 100%;
    }
    #editModal img {
      max-width: 100%;
      height: auto;
      margin: 8px 0;
      display: block;
    }
  </style>
</head>
<body>
  <h1>Card Builder</h1>
  <div id="controls">
    <input type="text" id="cardText" placeholder="Enter text">
    <input type="color" id="cardColor" value="#000000">
    <input type="file" id="cardImage">
    <div id="suggestions" class="suggestions" style="display:none;"></div>
    <button onclick="addCard()">Add Card</button>
    <button onclick="clearCards()">Clear</button>
    <button onclick="downloadPDF()">Download PDF</button>
  </div>
  <div id="preview"></div>

  <!-- Edit Modal -->
  <div id="editModal">
    <div class="modal-content">
      <h3>Edit Card</h3>
      <input type="text" id="editText" placeholder="Card text">
      <input type="color" id="editColor">
      <img id="editImagePreview" src="" alt="Current Image">
      <input type="file" id="editImageUpload">
      <div style="margin-top:10px; text-align:right;">
        <button onclick="saveEdit()">Save</button>
        <button onclick="closeEdit()">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const { jsPDF } = window.jspdf;

    let cards = [];
    let editIndex = null;

    // Symbol library with keywords
    const symbolLibrary = [
      { image: 'samples/red.png', keywords: ['red', 'stop', 'danger'] },
      { image: 'samples/green.png', keywords: ['green', 'go', 'safe'] },
      { image: 'samples/star.png', keywords: ['star', 'favourite', 'special'] },
      { image: 'samples/heart.png', keywords: ['heart', 'love'] }
    ];

    // Escape text for HTML
    function escapeHtml(text) {
      return text.replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
    }

    // Add new card
    function addCard() {
      const text = document.getElementById('cardText').value.trim();
      const color = document.getElementById('cardColor').value;
      const fileInput = document.getElementById('cardImage');
      const file = fileInput.files[0];
      const suggestion = document.querySelector('#suggestions div.selected');

      if (file) {
        const reader = new FileReader();
        reader.onloadend = () => {
          cards.push({ text, color, image: reader.result });
          renderPreview();
        };
        reader.readAsDataURL(file);
      } else if (suggestion) {
        const img = suggestion.getAttribute('data-img');
        cards.push({ text, color, image: img });
        renderPreview();
      } else {
        alert("Please select an image (upload or suggestion).");
      }

      document.getElementById('cardText').value = '';
      document.getElementById('cardImage').value = '';
      document.getElementById('suggestions').style.display = 'none';
    }

    // Remove card
    function removeCard(i) {
      cards.splice(i, 1);
      renderPreview();
    }

    // Clear all
    function clearCards() {
      cards = [];
      renderPreview();
    }

    // Render preview
    function renderPreview() {
      const preview = document.getElementById('preview');
      preview.innerHTML = '';
      cards.forEach((c, i) => {
        const d = document.createElement('div');
        d.className = 'card';
        d.draggable = true;
        d.innerHTML = `
          <div style="width:100px; height:80px; display:flex; align-items:center; justify-content:center; margin:0 auto 6px;">
            <img src="${c.image}" alt="img">
          </div>
          <div style="color:${c.color};"><strong>${escapeHtml(c.text)}</strong></div>
          <div style="margin-top:6px;">
            <button onclick="openEdit(${i})">Edit</button>
            <button onclick="removeCard(${i})">Remove</button>
          </div>
        `;
        // Drag events
        d.addEventListener('dragstart', e => {
          d.classList.add('dragging');
          e.dataTransfer.setData('text/plain', i);
        });
        d.addEventListener('dragend', () => d.classList.remove('dragging'));
        preview.appendChild(d);
      });
    }

    // Drag-and-drop reorder
    const preview = document.getElementById('preview');
    preview.addEventListener('dragover', e => {
      e.preventDefault();
      const afterElement = getDragAfterElement(preview, e.clientX);
      const dragging = document.querySelector('.dragging');
      if (afterElement == null) {
        preview.appendChild(dragging);
      } else {
        preview.insertBefore(dragging, afterElement);
      }
    });
    preview.addEventListener('drop', e => {
      e.preventDefault();
      const fromIndex = e.dataTransfer.getData('text/plain');
      const children = Array.from(preview.children);
      const toIndex = children.indexOf(document.querySelector('.dragging'));
      if (fromIndex >= 0 && toIndex >= 0) {
        const moved = cards.splice(fromIndex, 1)[0];
        cards.splice(toIndex, 0, moved);
        renderPreview();
      }
    });

    function getDragAfterElement(container, x) {
      const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // Suggestions
    const textInput = document.getElementById('cardText');
    const suggestionsDiv = document.getElementById('suggestions');

    textInput.addEventListener('input', () => {
      const val = textInput.value.toLowerCase();
      suggestionsDiv.innerHTML = '';
      if (!val) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      const matches = symbolLibrary.filter(s => s.keywords.some(k => k.includes(val)));
      if (matches.length > 0) {
        suggestionsDiv.style.display = 'block';
        matches.forEach(m => {
          const div = document.createElement('div');
          div.textContent = m.keywords[0];
          div.setAttribute('data-img', m.image);
          div.onclick = () => {
            document.querySelectorAll('#suggestions div').forEach(d => d.classList.remove('selected'));
            div.classList.add('selected');
          };
          suggestionsDiv.appendChild(div);
        });
        const rect = textInput.getBoundingClientRect();
        suggestionsDiv.style.left = rect.left + 'px';
        suggestionsDiv.style.top = rect.bottom + 'px';
        suggestionsDiv.style.width = rect.width + 'px';
        suggestionsDiv.style.position = 'absolute';
      } else {
        suggestionsDiv.style.display = 'none';
      }
    });

    // PDF
    function downloadPDF() {
      const doc = new jsPDF();
      const cardW = 60, cardH = 60;
      let x = 10, y = 10;
      cards.forEach((c, i) => {
        doc.rect(x, y, cardW, cardH); // border
        if (c.image) doc.addImage(c.image, 'PNG', x+2, y+2, cardW-4, cardH-20);
        doc.setTextColor(c.color);
        doc.text(c.text, x+cardW/2, y+cardH-5, { align: 'center' });
        x += cardW + 10;
        if (x + cardW > 200) { x = 10; y += cardH + 10; }
      });
      doc.save('cards.pdf');
    }

    // Edit modal
    function openEdit(i) {
      editIndex = i;
      const c = cards[i];
      document.getElementById('editText').value = c.text;
      document.getElementById('editColor').value = c.color || "#000000";
      document.getElementById('editImagePreview').src = c.image;
      document.getElementById('editModal').style.display = 'flex';
    }
    function closeEdit() {
      editIndex = null;
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('editImageUpload').value = '';
    }
    function saveEdit() {
      if (editIndex === null) return;
      const text = document.getElementById('editText').value.trim();
      const color = document.getElementById('editColor').value;
      const imgFile = document.getElementById('editImageUpload').files[0];
      if (imgFile) {
        const reader = new FileReader();
        reader.onloadend = () => {
          cards[editIndex] = { text, color, image: reader.result };
          renderPreview();
          closeEdit();
        };
        reader.readAsDataURL(imgFile);
      } else {
        cards[editIndex] = { text, color, image: cards[editIndex].image };
        renderPreview();
        closeEdit();
      }
    }
  </script>
</body>
</html>
