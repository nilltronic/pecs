<style>
  .card {
    position: relative;
    border: 1px solid black;
    display: inline-flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    margin: 5px;
    padding: 5px;
    box-sizing: border-box;
    font-size: 14px;
  }

  .card img {
    max-width: 80%;
    max-height: 60%;
    object-fit: contain;
    margin-bottom: 5mm;
  }

  .grab-handle {
    position: absolute;
    top: 2px;
    right: 22px;
    cursor: grab;
    font-size: 14px;
    color: #555;
  }

  .delete-btn {
    position: absolute;
    top: 2px;
    right: 2px;
    cursor: pointer;
    font-size: 14px;
    color: red;
  }

  /* Modal styling */
  #editModal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0; top: 0;
    width: 100%; height: 100%;
    background-color: rgba(0,0,0,0.5);
  }

  #editModalContent {
    background: white;
    margin: 10% auto;
    padding: 20px;
    width: 300px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }
</style>

<div id="preview"></div>

<!-- Edit Modal -->
<div id="editModal">
  <div id="editModalContent">
    <label>Text: <input type="text" id="editText"></label>
    <label>Color: <input type="color" id="editColor"></label>
    <label>Change Image: <input type="file" id="editImage" accept="image/*"></label>
    <button id="saveEdit">Save</button>
    <button id="cancelEdit">Cancel</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  let cards = [];
  let editIndex = null;

  function renderPreview() {
    const preview = document.getElementById("preview");
    preview.innerHTML = "";
    cards.forEach((card, index) => {
      const div = document.createElement("div");
      div.className = "card";
      div.style.width = "55mm";   // your base card width
      div.style.height = "60mm";  // your base card height
      div.innerHTML = `
        <div class="grab-handle">☰</div>
        <div class="delete-btn">❌</div>
        <img src="${card.image}" alt="">
        <div class="card-text" style="color:${card.color}">${card.text}</div>
      `;

      // Delete
      div.querySelector(".delete-btn").onclick = () => {
        cards.splice(index, 1);
        renderPreview();
      };

      // Edit (anywhere except grab/delete)
      div.addEventListener("click", (e) => {
        if (e.target.classList.contains("grab-handle") ||
            e.target.classList.contains("delete-btn")) return;
        openEditCard(index);
      });

      preview.appendChild(div);
    });
  }

  function openEditCard(index) {
    editIndex = index;
    const card = cards[index];
    document.getElementById("editText").value = card.text;
    document.getElementById("editColor").value = card.color || "#000000";
    document.getElementById("editImage").value = "";
    document.getElementById("editModal").style.display = "block";
  }

  function closeEditCard() {
    document.getElementById("editModal").style.display = "none";
    editIndex = null;
  }

  document.getElementById("saveEdit").onclick = () => {
    if (editIndex !== null) {
      const card = cards[editIndex];
      card.text = document.getElementById("editText").value;
      card.color = document.getElementById("editColor").value;

      const fileInput = document.getElementById("editImage");
      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          card.image = e.target.result;
          renderPreview();
          closeEditCard();
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else {
        renderPreview();
        closeEditCard();
      }
    }
  };

  document.getElementById("cancelEdit").onclick = closeEditCard;

  // Enable drag and drop with handle only
  new Sortable(document.getElementById("preview"), {
    animation: 150,
    handle: ".grab-handle",
    onEnd(evt) {
      const moved = cards.splice(evt.oldIndex, 1)[0];
      cards.splice(evt.newIndex, 0, moved);
      renderPreview();
    }
  });

  // Example starter cards
  cards = [
    { text: "Stop", image: "https://via.placeholder.com/100", color: "#000000" },
    { text: "Go", image: "https://via.placeholder.com/100", color: "#000000" }
  ];
  renderPreview();
</script>
